version: 1
kind: stack
meta:
  name: GKE Sandbox Stack
  brief: GKE Sandbox Stack

components:
- name: gke
  source:
    dir: components/gke-gcloud
    git:
      remote: https://github.com/agilestacks/google-components.git
      subDir: gke-gcloud
- name: nginx
  source:
    dir: components/nginx
    git:
      remote: https://github.com/agilestacks/google-components.git
      subDir: nginx
- name: external-dns
  source:
    dir: components/external-dns
    git:
      remote: https://github.com/agilestacks/google-components.git
      subDir: external-dns
- name: online-boutique-app
  source:
    dir: components/online-boutique-app
    git:
      remote: https://github.com/agilestacks/google-components.git
      subDir: online-boutique-app

extensions:
  init:
    - gcp
    - .hub/after-init
  configure:
    - gcp
    - env

requires:
- gcp

lifecycle:
  verbs:
  - deploy
  - undeploy
  order:
  - gke
  - nginx
  - external-dns
  - online-boutique-app

parameters:
  - name: hub.userAccount
    fromEnv: USER_ACCOUNT

  - name: projectId
    fromEnv: GOOGLE_PROJECT
  - name: dns.domain
    fromEnv: HUB_DOMAIN_NAME
  - name: stateBucketName
    fromEnv: HUB_STATE_BUCKET
  - name: hubStackName
    fromEnv: HUB_STACK_NAME

  - name: component.gke
    parameters:
    - name: name
      value: ${hubStackName}
    - name: zone
      fromEnv: GOOGLE_ZONE
    - name: region
      fromEnv: GOOGLE_REGION
    - name: machineType
      value: e2-standard-4
    - name: nodeCount
      value: 2
    - name: version
      value: 1.21

  - name: component.onlineBoutiqueApp
    parameters:
    - name: host
      value: boutique.${dns.domain}

outputs:
- name: component.onlineBoutiqueApp.host
- name: component.gke.url
